# Apex Continuous Integration Workflow for Node.js CLI
# Standard: Node.js 20.x LTS (LTS: Finch/Gallium - Dec 2025 Context)

name: CI - FluentPDF Build & Verify

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_test:
    name: Build, Lint, Test
    runs-on: ubuntu-latest
    env:
      # Apex Environment Variables for Consistency
      NODE_VERSION: '20.x'
      LINT_TOOL: 'biome'
      TEST_TOOL: 'vitest'

    steps:
      - name: ğŸ›‘ Checkout Repository
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies (uv replacement standard)
        run: npm ci

      - name: ğŸ§¹ Static Analysis & Formatting (Biome)
        # Biome enforces style and catches lint errors rapidly
        run: npx ${{ env.LINT_TOOL }} check --apply-unsafe

      - name: ğŸ”¬ Unit & Integration Testing (Vitest)
        # Assuming test coverage reports are generated
        run: npx vitest run --coverage --coverage.reportOnFailure=true

      - name: ğŸ“Š Upload Coverage Reports (Codecov)
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/cobertura-coverage.xml
          flags: cli,node

      - name: âœ… Verify Final State (Zero Defects)
        run: echo "Build and quality checks passed successfully. Ready for deployment promotion."

  security:
    name: Security Audit (Snyk)
    runs-on: ubuntu-latest
    needs: build_and_test
    # Integrating modern security scanning practice (Snyk as a standard choice)
    if: success()
    steps:
      - name: ğŸ›‘ Checkout Repository
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ›¡ï¸ Install Snyk CLI
        run: npm install -g snyk

      - name: ğŸ” Run Snyk Vulnerability Scan
        # Requires SNYK_TOKEN secret
        run: snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  release:
    name: Automated Release Prep
    runs-on: ubuntu-latest
    needs: [build_and_test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: ğŸ›‘ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: â¬†ï¸ Prepare Release Bump (Standardized SemVer)
        run: | 
          npm install -g semantic-release-cli
          # This step assumes semantic-release/semantic-release is configured in package.json
          # We run a dry run for demonstration purposes or trigger the actual release if secrets are present
          echo "Triggering automated semantic release preparation on main branch."
          npx semantic-release --dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}